{"version":3,"file":"index.mjs","sources":["../src/events.ts","../src/webmi.ts","../src/data.ts"],"sourcesContent":["export type EventHandler<E> = (e: E) => void;\n\n/**\n * Registers an event handler. Can be used with DOM elements as well as with webMI internal modules\n * (such as webMI.data).\n * @param target The event target.\n * @param name The event to handle.\n * @param handler The event handler.\n */\nexport function addEvent<E>(target: any, name: string, handler: EventHandler<E>) {\n  let active = true;\n\n  webMI.addEvent(target, name, (e) => {\n    if (!active) return;\n    handler(e);\n  });\n\n  // NOTE: webMI.removeEvent is not implemented for all events ðŸ™„\n  // We call it with the same signature as addEvent, but don't rely on it to work.\n  return () => {\n    active = false;\n    (webMI.removeEvent as typeof webMI.addEvent)(target, name, handler);\n  };\n}\n","/* eslint-disable import/prefer-default-export */\n\n/// <reference types=\"@atvise/types-webmi\" />\n\nexport function getWebMI() {\n  if (!window.webMI) {\n    throw new Error(`No webmi detected. Is your atvise server running?`);\n  }\n\n  return window.webMI;\n}\n","import { addEvent } from './events';\nimport { getWebMI } from './webmi';\n\nexport type VariableValue<T> = webMI.data.VariableValue<T>;\ntype ResultError = webMI.data.ResultError;\n\nconst webmiData = getWebMI().data;\n\nfunction isErrorResult(result): result is ResultError {\n  return result.error;\n}\n\nconst createDataError = (result: ResultError) =>\n  Object.assign(new Error(result.errorstring), { code: result.error });\n\nfunction resultCallback<R>(resolve: (result: R) => void, reject: (error: Error) => void) {\n  return (result: ResultError | R) => {\n    if (isErrorResult(result)) {\n      reject(createDataError(result));\n    } else {\n      resolve(result);\n    }\n  };\n}\n\ntype DataCall<R> = (callback: (result: ResultError | R) => void) => void;\n\nfunction promisifyDataCall<R>(fn: DataCall<R>) {\n  return new Promise<R>((resolve, reject) => fn(resultCallback(resolve, reject)));\n}\n\nexport function read<V = any>(address: string) {\n  return promisifyDataCall<VariableValue<V>>((cb) => webmiData.read(address, cb));\n}\n\nexport function write<V>(address: string, value: V) {\n  return promisifyDataCall<void>((cb) => webmiData.write(address, value, cb));\n}\n\nexport function call<V = any>(name: string, args: Record<string, string>) {\n  return promisifyDataCall<V>((cb) => webmiData.call(name, args, cb));\n}\n\nconst isLoginErrorResult = (\n  result: webMI.data.LoginResult\n): result is webMI.data.LoginErrorResult => Object.prototype.hasOwnProperty.call(result, 'error');\nconst isLoginSuccessResult = (\n  result: webMI.data.LoginResult\n): result is webMI.data.LoginSuccessResult => !isLoginErrorResult(result) && !!result.username;\n\nexport function login(username: string, password: string): Promise<webMI.data.LoginSuccessResult> {\n  return new Promise((resolve, reject) => {\n    webmiData.login(username, password, ({ '': result }) => {\n      if (isLoginErrorResult(result)) reject(new Error(result.error));\n      else resolve(isLoginSuccessResult(result) ? result : null);\n    });\n  });\n}\n\nexport function logout() {\n  return new Promise<void>((resolve) => webmiData.logout(resolve));\n}\n\nexport const addDataEvent = <N extends keyof webMI.data.DataEvents>(\n  name: N,\n  callback: (e: webMI.data.DataEvents[N]) => void\n) => addEvent(webmiData, name, callback);\n\ntype SubscriptionState<V> = { error: Error } | { data: VariableValue<V> };\n\nexport function subscribe<V>(address: string, onResult: (data: SubscriptionState<V>) => void) {\n  const subscription = webmiData.subscribe(address, (result) =>\n    onResult(isErrorResult(result) ? { error: createDataError(result) } : { data: result })\n  );\n\n  return {\n    cancel: () => webmiData.unsubscribe(subscription),\n  };\n}\n"],"names":[],"mappings":"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"}